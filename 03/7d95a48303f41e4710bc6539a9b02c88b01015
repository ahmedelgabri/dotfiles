set nocompatible

" https://github.com/justinmk/config/blob/master/.vimrc#L87-L94
let s:plugins=filereadable(expand("~/.vim/autoload/plug.vim", 1))

if !s:plugins

  fun! InstallPlug() "bootstrap plug.vim on new systems
    silent call mkdir(expand("~/.vim/autoload", 1), 'p')
    exe '!curl -fLo '.expand("~/.vim/autoload/plug.vim", 1).' https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
  endfun

else

  " Vim-Plug https://github.com/junegunn/vim-plug
  "================================================================================
  call plug#begin('~/.vim/plugged')

  " General

  if has('lua')
    Plug 'Shougo/neocomplete.vim'
  end
  Plug 'SirVer/ultisnips'
  Plug 'Raimondi/delimitMate'
  Plug 'Shougo/vimproc.vim'               , { 'do': 'make' }
  Plug 'Shougo/unite.vim'
  Plug 'mattn/emmet-vim'                  , { 'for': ['html', 'htmldjango'] }
  Plug 'ervandew/supertab'
  Plug 'rking/ag.vim'                     , { 'on': 'Ag' }
  Plug 'pbrisbin/vim-mkdir'
  Plug 'tpope/vim-commentary'
  Plug 'tpope/vim-surround'
  Plug 'tpope/vim-repeat'
  Plug 'godlygeek/tabular'
  Plug 'kakkyz81/evervim'                 , { 'do': 'pip install markdown', 'on': ['EvervimNotebookList', 'EvervimCreateNote'] }
  Plug 'mrtazz/simplenote.vim'
  Plug 'moll/vim-bbye'
  Plug 'sjl/gundo.vim'
  Plug 'majutsushi/tagbar'                , { 'on': 'TagbarToggle' }
  Plug 'ConradIrwin/vim-bracketed-paste'
  Plug 'xolox/vim-misc'
  Plug 'xolox/vim-easytags'
  Plug 'scrooloose/nerdtree'
  Plug 'jistr/vim-nerdtree-tabs'
  Plug 'szw/vim-g'

  " Syntax
  Plug 'digitaltoad/vim-jade'             , { 'for': ['jade'] }
  Plug 'jelera/vim-javascript-syntax'     , { 'for': ['javascript'] }
  Plug 'moll/vim-node'
  Plug 'mustache/vim-mustache-handlebars'
  Plug 'mxw/vim-jsx'                      , { 'for': ['jsx'] }
  Plug 'othree/html5.vim'                 , { 'for': ['html', 'htmldjango'] }
  Plug 'tpope/vim-markdown'               , { 'for': ['markdown'] }
  Plug 'wavded/vim-stylus'                , { 'for': ['stylus'] }
  Plug 'ap/vim-css-color'
  Plug 'tpope/vim-git'                    , { 'for': ['git','gitcommit','gitconfig','gitolite','gitrebase','gitsendemail'] }
  Plug 'elzr/vim-json'                    , { 'for': ['json'] }
  Plug 'groenewege/vim-less'              , { 'for': ['less'] }
  Plug 'kchmck/vim-coffee-script'         , { 'for': ['coffee'] }

  " Linters & Code quality
  Plug 'editorconfig/editorconfig-vim'
  Plug 'scrooloose/syntastic'

  " Status bar
  Plug 'bling/vim-airline'

  " Colors
  Plug 'altercation/vim-colors-solarized'
  Plug 'chriskempson/base16-vim'
  Plug 'morhetz/gruvbox'

  " Git
  " Plug 'airblade/vim-gitgutter' " Slows Vim loading?
  Plug 'mattn/gist-vim'
  Plug 'mattn/webapi-vim'
  Plug 'tpope/vim-fugitive'

  " Misc.
  Plug 'rizzatti/dash.vim'                , { 'on': 'Dash' }
  Plug 'Z1MM32M4N/vim-superman'
  Plug 'vim-scripts/utl.vim'

  " Distraction-free writing
  Plug 'junegunn/limelight.vim'
  Plug 'junegunn/goyo.vim'

  call plug#end()

  syntax enable
  filetype plugin indent on


  " Plugins settings
  "================================================================================

  set t_Co=256
  if strftime("%H") < 17
    set background=light
  else
    set background=dark
  endif
  let g:gruvbox_italic=0
  color base16-ocean

  " JavaScript
  let g:javascript_enable_domhtmlcss = 1

  " Syntastic
  let g:syntastic_scss_checkers = ['scss_lint']
  let g:syntastic_mode_map = { "mode": "active",
        \ 'active_filetypes': [],
        \ 'passive_filetypes': ['html'] }
  au FileType javascript let b:syntastic_checkers = findfile('.eslintrc', '.;') != '' ? ['eslint'] : ['jshint']
  let g:syntastic_error_symbol = '✗'
  let g:syntastic_warning_symbol = '!'

  " SuperTab
  let g:SuperTabDefaultCompletionType = "context"

  " Ag
  let g:agprg="ag --column"

  " Emmet
  let g:user_emmet_install_global = 0
  " let g:user_emmet_leader_key = '<Leader>'
  let user_emmet_expandabbr_key = '<C-e>'
  " imap <expr> <tab> emmet#expandAbbrIntelligent("\<tab>")
  let g:user_emmet_next_key='<C-n>'
  let g:use_emmet_complete_tag = 1
  au FileType html,htmldjango EmmetInstall

  " Airline
  if !exists('g:airline_symbols')
    let g:airline_symbols = {}
  endif
  let g:airline_mode_map = {
        \ '__' : '-',
        \ 'n' : 'N',
        \ 'i' : 'I',
        \ 'R' : 'R',
        \ 'c' : 'C',
        \ 'v' : 'V',
        \ 'V' : 'V',
        \ '' : 'V',
        \ 's' : 'S',
        \ 'S' : 'S',
        \ '' : 'S',
        \ }
  let g:airline_powerline_fonts = 1
  let g:airline_detect_paste=1
  let g:airline#extensions#tabline#enabled = 1
  let g:airline#extensions#tabline#left_alt_sep = '¦'
  let g:airline#extensions#tabline#right_alt_sep = '¦'
  let g:airline_detect_modified=1
  let g:airline_inactive_collapse=1
  let g:airline#extensions#syntastic#enabled = 1
  let g:airline#extensions#tagbar#enabled = 0
  let g:airline#extensions#tabline#buffer_nr_show = 1
  let g:airline#extensions#hunks#non_zero_only = 1
  let g:airline#extensions#hunks#enabled = 0

  " Tagbar
  let g:tagabar_show_linenumbers = -1
  let g:tagbar_singleclick = 1
  let g:tagbar_auto_open = 1

  " Github Auth
  let g:github_user = $GITHUB_USER
  " not working cause there is a problem with 2FA & Gist.vim
  "let g:github_token = $GITHUB_TOKEN
  let g:gist_detect_filetype = 1
  let g:gist_open_browser_after_post = 1

  " Neocomplete
  let g:neocomplete#enable_at_startup = 1
  let g:neocomplete#enable_smart_case = 1
  let g:neocomplete#sources#syntax#min_keyword_length = 3
  let g:neocomplete#auto_completion_start_length = 1
  let g:neocomplete#sources#buffer#cache_limit_size = 50000
  let g:neocomplete#data_directory = $HOME.'/.vim/cache/noecompl'
  let g:neocomplete#sources#syntax#min_keyword_length = 3
  if !exists('g:neocomplete#force_omni_input_patterns')
    let g:neocomplete#force_omni_input_patterns = {}
  endif
  let g:neocomplete#force_omni_input_patterns.javascript = '[^. \t]\.\w*'
  " Tab completion.
  inoremap <expr><TAB>  pumvisible() ? "\<C-n>" : "\<TAB>"

  aug omnicomplete
    au!
    au FileType css setl omnifunc=csscomplete#CompleteCSS
    au FileType markdown setl omnifunc=htmlcomplete#CompleteTags
    au FileType html,htmldjango setl omnifunc=emmet#completeTag
    au FileType javascript setl omnifunc=javascriptcomplete#CompleteJS
    au FileType python setl omnifunc=pythoncomplete#Complete
    au FileType xml setl omnifunc=xmlcomplete#CompleteTags
  aug END

  " Ultisnips
  let g:UltiSnipsExpandTrigger="<tab>"
  let g:UltiSnipsJumpForwardTrigger="<tab>"
  let g:UltiSnipsJumpBackwardTrigger="<s-tab>"
  let g:UltiSnipsSnippetDirectories=["UltiSnips"]

  " Unite
  let g:unite_force_overwrite_statusline = 0
  let g:unite_prompt = '>>> '

  call unite#custom_source('file_rec,file_rec/async,file_mru,file,buffer,grep',
        \ 'ignore_pattern', join(['\.git/', '\.sass-cache/' ,'tmp/', 'node_modules/', 'bower_components/'], '\|'))

  if executable('ag')
    let g:unite_source_rec_async_command= 'ag --follow --nocolor --nogroup --hidden -g ""'
    let g:unite_source_grep_command = 'ag'
    let g:unite_source_grep_default_opts = '--column --nogroup --nogroup'
    let g:unite_source_grep_recursive_opt = ''
  endif

  call unite#filters#matcher_default#use(['matcher_fuzzy'])
  call unite#filters#sorter_default#use(['sorter_rank'])

  au FileType unite call s:unite_settings()

  function! s:unite_settings()
    let b:SuperTabDisabled=1
    imap <buffer> <C-j>   <Plug>(unite_select_next_line)
    imap <buffer> <C-k>   <Plug>(unite_select_previous_line)
    imap <buffer> <Tab>   <Plug>(unite_complete)
    imap <silent><buffer><expr> <C-s> unite#do_action('split')
    imap <silent><buffer><expr> <C-v> unite#do_action('vsplit')
    imap <silent><buffer><expr> <C-t> unite#do_action('tabopen')
    nmap <buffer> <ESC> <Plug>(unite_exit)
  endfunction

  " Evernote
  let g:evervim_devtoken= $EVERNOTE_TOKEN

  " Simplenote
  if filereadable($HOME . '/.simplenote')
    source ~/.simplenote
  endif
  let g:SimplenoteFiletype = "markdown"

  " File Explorer
  let g:netrw_liststyle = 3
  let g:netrw_winsize   = 15
  let g:netrw_banner = 0

  " Vim Commentary
  au FileType jade set commentstring=//-\ %s
  au FileType ruby set commentstring=#\ %s
  au FileType htmldjango set commentstring={#\ %s\ #}

  " JSON
  let g:vim_json_syntax_conceal = 0

  " Goyo
  let g:goyo_width=120

  " Limelight
  let g:limelight_conceal_ctermfg = 240

  " Markdown
  let g:markdown_fenced_languages = ['css', 'erb=eruby', 'javascript', 'js=javascript', 'json=javascript', 'ruby', 'sass', 'scss=sass', 'xml', 'html', 'python', 'stylus=css']

  " Easytags
  set tags=./.tags,~/.tags
  let g:easytags_events = ['BufReadPost', 'BufWritePost']
  let g:easytags_async = 1
  let g:easytags_dynamic_files = 2
  let g:easytags_resolve_links = 1
  " let g:easytags_suppress_ctags_warning = 1

  " gitgutter

  " NerdTree
  let g:NERDTreeShowHidden=1
  let NERDTreeIgnore = ['\.pyc$']

endif

" Settings
"================================================================================

" UI Configs
"-----------------
" number of visual spaces per TAB
set tabstop=2
" insert mode tab and backspace, number of spaces in tab when editing
set softtabstop=2
" expand tabs to spaces
set expandtab
" normal mode indentation commands use 2 spaces
set shiftwidth=2
set autoindent
set shiftround

set nowrap

" highlight ColorColumn ctermbg=235 guibg=#2c2d27
let colorcolumn="80,120"

" show line numbers
set number

" show command in bottom bar
set showcmd

" Display the mode you're in.
set showmode

" show a navigable menu for tab completion
set wildmenu
set wildmode=longest,list,full
set wildignore+=*.o,*.out,*.obj,.git,*.rbc,*.rbo,*.class,.svn,*.gem,*.pyc
set wildignore+=*.zip,*.tar.gz,*.tar.bz2,*.rar,*.tar.xz
set wildignore+=*/vendor/gems/*,*/vendor/cache/*,*/.bundle/*,*/.sass-cache/*
set wildignore+=*/tmp/librarian/*,*/.vagrant/*,*/.kitchen/*,*/vendor/cookbooks/*
set wildignore+=*/tmp/cache/assets/*/sprockets/*,*/tmp/cache/assets/*/sass/*
set wildignore+=*.swp,*~,._*
set wildignore+=*/.DS_Store,*/tmp/*


set complete+=kspell

" Display as much as possibe of a window's last line.
set display+=lastline

" highlight current line (Check auto groups too)
set cursorline

" redraw only when we need to.
set lazyredraw

" highlight matching [{()}]
set showmatch
set title
hi MatchParen cterm=none ctermbg=black ctermfg=yellow

" More natural splitting
set splitbelow
set splitright

" Search
"-----------------
" search as characters are entered
set incsearch

" highlight matches
set hlsearch

" Ignore case in search.
set ignorecase

" But case-sensitive if expression contains a capital letter.
set smartcase

" Movement
"-----------------
" highlight last inserted text
nnoremap gV `[v`]

" Other
" TODO: Cleanup.
"-----------------

" No beeping.
set visualbell

" No flashing.
set noerrorbells

" History
set history=200

" reload files when changed on disk, i.e. via `git checkout`
set autoread

" Fix broken backspace in some setups
set backspace=2

" Start scrolling slightly before the cursor reaches an edge
set scrolloff=3
set sidescrolloff=5

" Scroll sideways a character at a time, rather than a screen at a time
set sidescroll=1

" yank and paste with the system clipboard
set clipboard=unnamed

" Alwyas use UTF-8
set encoding=utf-8

" always show statusline
set laststatus=2

" show trailing whitespace
set list
set listchars=tab:▸\ ,trail:·,nbsp:_,eol:¬,precedes:«,extends:»,nbsp:░
" show where you are
set ruler

set smartindent

set noswapfile

set hidden

" Enable mouse support
set mouse=a
" Swap iTerm2 cursors in vim insert mode when using tmux, more here https://gist.github.com/andyfowler/1195581
if exists('$TMUX')
  let &t_SI = "\<Esc>Ptmux;\<Esc>\<Esc>]50;CursorShape=1\x7\<Esc>\\"
  let &t_EI = "\<Esc>Ptmux;\<Esc>\<Esc>]50;CursorShape=0\x7\<Esc>\\"
else
  let &t_SI = "\<Esc>]50;CursorShape=1\x7"
  let &t_EI = "\<Esc>]50;CursorShape=0\x7"
endif

set ttyfast

set formatoptions=qrn1

" No backups.
set nobackup
set nowritebackup

" Make tilde command behave like an operator.
set tildeop

" Avoid unnecessary hit-enter prompts.
set shortmess+=atI

nmap <F2> :set invpaste paste?<CR>
set pastetoggle=<F2>

" Spell check
if has('nvim')
" `set spell` gives errors in Neovim https://github.com/neovim/neovim/issues/1551
  set nospell
else
  set spell
  hi clear SpellBad
  " hi SpellBad term=standout ctermfg=1 term=underline cterm=underline
endif

" Autocommands
"================================================================================
" Automatically make splits equal in size
au VimResized * wincmd =

augroup vimrcEx
  au!

  " When editing a file, always jump to the last known cursor position.
  " Don't do it for commit messages, when the position is invalid, or when
  " inside an event handler (happens when dropping a file on gvim).
  au BufReadPost *
    \ if &ft != 'gitcommit' && line("'\"") > 0 && line("'\"") <= line("$") |
    \   exe "normal g`\"" |
    \ endif

  " Some file types use real tabs
  au FileType {make,gitconfig} set noexpandtab

  " Make sure all markdown files have the correct filetype set and setup wrapping
  au BufWritePre * call Preserve("%s/\\s\\+$//e")
  au FileType markdown setl wrap textwidth=120 nolist statusline+=\ delimitMate_nesting_quotes=["`"] %{WordCount()}

  " #2 http://robots.thoughtbot.com/5-useful-tips-for-a-better-commit-message
  au Filetype gitcommit setl spell textwidth=72

  " fdoc is yaml
  au BufRead,BufNewFile *.fdoc set ft=yaml
  au BufRead,BufNewFile {Gemfile,Rakefile,Vagrantfile,Thorfile,Procfile,Guardfile,config.ru,*.rake} set ft=ruby
  " make Python follow PEP8 ( http://www.python.org/dev/peps/pep-0008/ )
  au FileType python setl softtabstop=4 tabstop=4 shiftwidth=4 textwidth=79 commentstring=#\ %s
  au BufRead,BufNewFile,BufReadPre *.coffee set ft=coffee

  au BufRead,BufNewFile *.json set ft=json
  au BufNewFile,BufRead,BufWrite * if getline(1) =~ '^\#!.*node' | setf javascript | endif
  " Don't show column width marker in HTML & md
  au BufNewFile,BufRead *.{html,md} setl colorcolumn=0

  au BufNewFile,BufRead *.html set ft=htmldjango
  au BufNewFile,BufRead .tags set ft=tags

  " Allow stylesheets to autocomplete hyphenated words
  au FileType css,scss,sass setl iskeyword+=-
augroup END

" Activate goyo with Markdown files
function! s:auto_goyo()
  if &ft == 'markdown'
    Goyo 120
  elseif exists('#goyo')
    let bufnr = bufnr('%')
    Goyo!
    execute 'b '.bufnr
  endif
endfunction

augroup goyo_markdown
  au!
  au BufNewFile,BufRead * call s:auto_goyo()
augroup END

" Key mappings
"================================================================================

" leader is <space>
let mapleader = ' '
map <C-h> <C-w>h
map <C-j> <C-w>j
map <C-k> <C-w>k
map <C-l> <C-w>l
map <silent> <leader>sv :source ~/.vimrc<CR>:filetype detect<CR>:exe ":echo 'vimrc reloaded'"<CR>

imap jj <ESC>
" nnoremap jj <C-]>
" nnoremap kk <C-t>
nmap <Leader>q :q<CR>
nmap <Leader>w :w<CR>
nmap <Leader>e :e
nmap <Leader>v :vsplit
nmap <Leader>s :split
nmap <Leader>p :Unite buffer -buffer-name=files -start-insert -auto-preview -no-split file_rec/async<CR>
nmap <Leader>n :call ToggleNumber()<CR>
nmap <Leader>t :TagbarToggle<CR>
" nmap <leader>d :Lex<CR>
nmap <leader>d :NERDTreeTabsToggle<CR>
nmap <leader>dd :Dash<CR>
nmap <Leader>bd :Bdelete<CR>
nmap <Leader><TAB> <C-w><C-w>
" set text wrapping toggles
nmap <silent> <leader>tw :set invwrap<CR>:set wrap?<CR>
nmap <leader>hs :set hlsearch! hlsearch?<CR>
nmap <leader>ss :mksession<CR>
nmap <leader>g :GundoToggle<CR>
nmap <leader>ll :Limelight!!<CR>
nmap <leader>fm :Goyo<CR>

" Make dot work in visual mode
vmap . :norm.<CR>

" Convenience commands and cabbrev's
"================================================================================
"
" Make these commonly mistyped commands still work
command! WQ wq
command! Wq wq
command! Wqa wqa
command! W w
command! Q q

" Use :C to clear hlsearch
command! C nohlsearch

" Force write readonly files using sudo
command! WS w !sudo tee %

" open help in a new tab
cabbrev help tab help

" Functions
"================================================================================

function! ClearRegisters()
  let regs='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789/-="*+'
  let i=0
  while (i<strlen(regs))
    exec 'let @'.regs[i].'=""'
    let i=i+1
  endwhile
endfunction

command! ClearRegisters call ClearRegisters()

" toggle between number and relativenumber
function! ToggleNumber()
  if(&relativenumber == 1)
    set norelativenumber
    set number
  else
    set relativenumber
  endif
endfunc

" strips trailing whitespace at the end of files. this
" is called on buffer write in the autogroup above.
function! Preserve(command)
  " Preparation: save last search, and cursor position.
  let _s=@/
  let l = line(".")
  let c = col(".")
  " Do the business:
  execute a:command
  " Clean up: restore previous search history, and cursor position
  let @/=_s
  call cursor(l, c)
endfunction
nmap _$ :call Preserve("%s/\\s\\+$//e")<CR>
nmap _= :call Preserve("normal gg=G")<CR>

" word count, taken from
" http://stackoverflow.com/questions/114431/fast-word-count-function-in-vim
function! WordCount()
  let s:old_status = v:statusmsg
  let position = getpos(".")
  exe ":silent normal g\<c-g>"
  let stat = v:statusmsg
  let s:word_count = 0
  if stat != '--No lines in buffer--'
    let s:word_count = str2nr(split(v:statusmsg)[11])
    let v:statusmsg = s:old_status
  end
  call setpos('.', position)
  return s:word_count
endfunction

function! s:setupWrapping()
  set wrap
  set wrapmargin=2
  set textwidth=80
endfunction

" Load matchit.vim, but only if the user hasn't installed a newer version.
" https://github.com/tpope/vim-sensible/blob/master/plugin/sensible.vim#L88
if !exists('g:loaded_matchit') && findfile('plugin/matchit.vim', &rtp) ==# ''
  runtime! macros/matchit.vim
endif

" Overrrides
" =================
if filereadable(expand("~/.vimrc.local"))
  source ~/.vimrc.local
endif
